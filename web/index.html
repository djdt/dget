<html>
<head>
    <title>D Get</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
    <style>
    * {box-sizing: border-box;}
    .header, .footer {padding: 10px}
    .clearfix::after { content: ""; clear: both; display: table}
    label {display: inline-block; text-align: left; width: 30%}
    label[type=radio] {width: 5%}
    input:not([type=radio]) {display: inline-block; width: 60%}
    .input, .output {background: lightgrey; float: left; width: 50%; padding: 10px}
    </style>
<body>
    <py-config>
        packages = ["numpy", "matplotlib", "dget"]
    </py-config>

    <div class="header">
        <h1>DGet!</h1>
    </div>

    <div class="clearfix">
        <div class="input">
            <label for="formula"> Formula: </label>
            <input type="text" id="formula" name="formula">
            <br><br>
            <label for="file"> Upload MS Data: </label>
            <input type="file" id="file", name="file">
            <br><br>
            <label for="delimiter"> File delimiter: </label>
            <input type="radio" id="comma", name="delimiter", value=",", checked="checked">
            <label for="comma", type="radio"> , </label>
            <input type="radio" id="semicolon", name="delimiter", value=";">
            <label for="semicolon", type="radio"> ; </label>
            <input type="radio" id="tab", name="delimiter", value="\t">
            <label for="tab", type="radio"> Tab </label>
            <input type="radio" id="space", name="delimiter", value=" ">
            <label for="space", type="radio"> Space </label>
            <br><br>
            <label for="skiprows"> Skip rows: </label>
            <input type="number", id="skiprows", name="skiprows", min="0", value="0">
            <br><br>
            <label for="masscol"> Mass column: </label>
            <input type="number", id="masscol", name="masscol", min="1", value="1">
            <br><br>
            <label for="signalcol"> Signal column: </label>
            <input type="number", id="signalcol", name="signalcol", min="1", value="2">
            <br><br>
            <button py-click="run()", id="submit">Get D</button>
        </div>
        <br>
        <div class="figure", id="figure"></div>
    </div>
    <br>
    <div class="footer">
        <div class="terminal">
            <py-terminal></py-terminal>
        </div>
    </div>

    <py-script>
        import matplotlib.pyplot as plt
        from pyodide import create_proxy
        import io
        import asyncio
        from dget import DGet

        path = None
        reader = js.FileReader

        def parse_inputs() -> dict | None:
            inputs = {"formula": Element('formula').value}
            if inputs['formula'] == "":
                print('Formula is empty.')
                return None
            inputs['delimiter'] = js.document.querySelector("[name='delimiter']:checked").value
            inputs['skiprows'] = int(Element('skiprows').value or 0)
            masscol = int(Element('masscol').value or 1) - 1
            signalcol = int(Element('signalcol').value or 1) - 1
            if masscol == signalcol:
                print("Mass and signal columns must be different.")
                return None
            inputs['usecols'] = (masscol, signalcol)
            return inputs

        def run():
            inputs = parse_inputs()
            print(inputs, path)
            if inputs is None or path is None:
                return
            
            dget = DGet(inputs.pop("formula"), path, loadtxt_kws=inputs)

            fig, ax = plt.subplots(1, 1)
            dget.plot_predicted_spectra(ax)
            display(fig, target="figure")
            print("Success")

        async def _get_ms_data(event):
            file = event.target.files.item(0)
            path = io.StringIO(await file.text())

        def make_async_event(event):
            asyncio.ensure_future(_get_ms_data(event))

        proxy = create_proxy(make_async_event)
        js.document.getElementById("file").addEventListener("change", proxy)
    </py-script>

</body>
