<html>
<head>
    <title>D Get</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
    <style>
    * {box-sizing: border-box;}
    .header, .footer {padding: 10px}
    .input, .figure { float: left; width: 50%; padding: 10px}
    .clearfix::after {background: lightgrey; content: ""; clear: both; display: table}
    label {display: inline-block; text-align: left; width: 30%}
    label[type=radio] {width: 5%}
    input:not([type=radio]) {display: inline-block; width: 60%}
    </style>
<body>
    <py-config>
        packages = ["numpy", "matplotlib", "dget"]
    </py-config>
    <py-script>
import matplotlib.pyplot as plt
from pyodide.ffi import create_proxy
from pathlib import Path
from dget import DGet

def parse_inputs() -> dict | None:
    inputs = {"formula": Element('formula').value}
    inputs['delimiter'] = js.document.querySelector("[name='delimiter']:checked").value
    if inputs['delimiter'] == "tab":
        inputs['delimiter'] = "\t"
    inputs['skiprows'] = int(Element('skiprows').value or 0)
    masscol = int(Element('masscol').value or 1) - 1
    signalcol = int(Element('signalcol').value or 1) - 1
    inputs['usecols'] = (masscol, signalcol)
    return inputs

def run():
    inputs = parse_inputs()
    path = Path("data.csv")
    if inputs["formula"] == "":
        print("Error: invalid formula input.")
        return
    if inputs["usecols"][0] == inputs["usecols"][1]:
        print("Error: signal and massmcolumns cannot be the same.")
        return
    if not path.exists():
        print("Error: no file uploaded.")
        return
    
    try:
        dget = DGet(inputs.pop("formula"), path, loadtxt_kws=inputs)
    except Exception as e:
        print(e)
        return

    fig, ax = plt.subplots(1, 1, figsize=(5,3))
    dget.plot_predicted_spectra(ax)
    fig.tight_layout()
    display(fig, target="figure", append=False)
    print(f"Formula          : {dget.formula}")
    print(f"M/Z              : {dget.formula.mz}")
    print(f"Monoisotopic M/Z : {dget.formula.isotope.mz}")
    print(f"%D               : {dget.deuteration * 100.0:.2f}")
    print()
    print("Deuteration Ratio Spectra")
    for i, p in enumerate(dget.deuteration_probabilites):
        print(f"D{i:<2}              : {p:.4f}")

async def get_ms_data(event):
    file = event.target.files.item(0)
    text = await file.text()
    path = Path("data.csv")
    with Path("data.csv").open("w") as fp:
        fp.write(text)

proxy = create_proxy(get_ms_data)
js.document.getElementById("file").addEventListener("change", proxy, False)
    </py-script>

    <div class="header">
        <h1>DGet!</h1>
    </div>

    <div class="clearfix">
        <div class="input">
            <label for="formula"> Formula: </label>
            <input type="text" id="formula" name="formula">
            <br><br>
            <label for="file"> Upload MS Data: </label>
            <input type="file" id="file", name="file">
            <br><br>
            <label for="delimiter"> File delimiter: </label>
            <input type="radio" id="comma", name="delimiter", value=",", checked="checked">
            <label for="comma", type="radio"> , </label>
            <input type="radio" id="semicolon", name="delimiter", value=";">
            <label for="semicolon", type="radio"> ; </label>
            <input type="radio" id="tab", name="delimiter", value="tab">
            <label for="tab", type="radio"> Tab </label>
            <input type="radio" id="space", name="delimiter", value=" ">
            <label for="space", type="radio"> Space </label>
            <br><br>
            <label for="skiprows"> Skip rows: </label>
            <input type="number", id="skiprows", name="skiprows", min="0", value="0">
            <br><br>
            <label for="masscol"> Mass column: </label>
            <input type="number", id="masscol", name="masscol", min="1", value="1">
            <br><br>
            <label for="signalcol"> Signal column: </label>
            <input type="number", id="signalcol", name="signalcol", min="1", value="2">
            <br><br>
            <button py-click="run()", id="submit">Get D</button>
        </div>
        <div class="figure", id="figure">
        </div>
    </div>
    <br>
    <div class="footer">
        <div class="terminal">
            <py-terminal></py-terminal>
        </div>
    </div>

</body>
